<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Command Center</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;800&family=Plus+Jakarta+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #eef2ff;
            --surface: #ffffff;
            --surface-2: #f7faff;
            --ink: #14213d;
            --muted: #51607c;
            --accent: #ff6b35;
            --accent-2: #ff9f1c;
            --teal: #00a896;
            --danger: #d7263d;
            --border: #d8e2f0;
            --ring: rgba(255, 107, 53, 0.25);
            --shadow: 0 18px 38px rgba(20, 33, 61, 0.12);
            --radius-xl: 24px;
            --radius-lg: 16px;
            --radius-md: 12px;
        }

        body.theme-dark {
            --bg: #0e1426;
            --surface: #131c33;
            --surface-2: #16213d;
            --ink: #f6f8ff;
            --muted: #9db0d6;
            --accent: #ff7f50;
            --accent-2: #ffb347;
            --teal: #2dd4bf;
            --danger: #ff6b7a;
            --border: #273353;
            --ring: rgba(255, 127, 80, 0.24);
            --shadow: 0 24px 50px rgba(0, 0, 0, 0.35);
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: "Plus Jakarta Sans", sans-serif;
            color: var(--ink);
            background:
                radial-gradient(900px 420px at -15% -20%, #d8defe 0, transparent 70%),
                radial-gradient(940px 420px at 115% -30%, #ffe5da 0, transparent 70%),
                var(--bg);
            min-height: 100vh;
        }

        .shell {
            width: min(1320px, 95vw);
            margin: 28px auto;
            display: grid;
            gap: 18px;
        }

        .topbar {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow);
            padding: 18px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .title {
            margin: 0;
            font-family: "Outfit", sans-serif;
            font-weight: 800;
            letter-spacing: -0.03em;
            font-size: clamp(1.5rem, 2.8vw, 2.2rem);
        }

        .subtitle {
            margin: 5px 0 0;
            color: var(--muted);
            font-size: 0.92rem;
        }

        .actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        button, select, input {
            font: inherit;
        }

        button {
            border: none;
            border-radius: 10px;
            padding: 10px 12px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 120ms ease, filter 120ms ease;
        }

        button:hover { transform: translateY(-1px); filter: brightness(1.03); }
        button:active { transform: translateY(0); }

        .btn-primary { background: linear-gradient(130deg, var(--accent), var(--accent-2)); color: #fff; }
        .btn-soft { background: var(--surface-2); color: var(--ink); border: 1px solid var(--border); }
        .btn-danger { background: rgba(215, 38, 61, 0.14); color: var(--danger); border: 1px solid rgba(215, 38, 61, 0.25); }

        .main {
            display: grid;
            grid-template-columns: 1.35fr 1fr;
            gap: 18px;
        }

        .panel {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow);
            padding: 16px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 12px;
        }

        .stat {
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 12px;
        }

        .stat .k {
            color: var(--muted);
            font-size: 0.78rem;
            margin-bottom: 4px;
        }

        .stat .v {
            font-size: 1.08rem;
            font-weight: 800;
            font-family: "Outfit", sans-serif;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .form-grid label {
            display: grid;
            gap: 6px;
            font-size: 0.85rem;
            font-weight: 700;
        }

        input, select {
            width: 100%;
            border: 1px solid var(--border);
            background: var(--surface-2);
            color: var(--ink);
            border-radius: 10px;
            padding: 10px;
            outline: none;
        }

        input:focus, select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 4px var(--ring);
        }

        .toolbar {
            display: grid;
            grid-template-columns: 1.2fr repeat(3, .6fr) auto;
            gap: 8px;
            margin-bottom: 10px;
        }

        .list {
            display: grid;
            gap: 8px;
            max-height: 420px;
            overflow: auto;
        }

        .row {
            border: 1px solid var(--border);
            background: var(--surface-2);
            border-radius: var(--radius-md);
            padding: 10px;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
        }

        .name {
            font-weight: 800;
            font-family: "Outfit", sans-serif;
        }

        .meta {
            font-size: 0.82rem;
            color: var(--muted);
        }

        .tag {
            display: inline-block;
            border-radius: 999px;
            padding: 4px 8px;
            font-size: 0.72rem;
            font-weight: 700;
            margin-top: 6px;
            border: 1px solid var(--border);
            background: #fff;
        }

        .tag.low { color: var(--danger); border-color: rgba(215, 38, 61, 0.3); background: rgba(215, 38, 61, 0.08); }

        .row-actions {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            align-content: center;
        }

        .chat {
            display: grid;
            grid-template-rows: auto 1fr auto;
            gap: 10px;
            min-height: 580px;
        }

        .chat-log {
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            background: var(--surface-2);
            padding: 10px;
            display: grid;
            gap: 8px;
            overflow: auto;
            max-height: 430px;
        }

        .bubble {
            max-width: 88%;
            padding: 9px 10px;
            border-radius: 12px;
            font-size: 0.87rem;
            line-height: 1.45;
        }

        .bubble.user {
            margin-left: auto;
            background: linear-gradient(130deg, var(--accent), var(--accent-2));
            color: #fff;
        }

        .bubble.bot {
            background: #fff;
            border: 1px solid var(--border);
            color: var(--ink);
        }

        .chips {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .chip {
            border: 1px solid var(--border);
            background: var(--surface-2);
            color: var(--ink);
            border-radius: 999px;
            padding: 6px 10px;
            font-size: 0.76rem;
            cursor: pointer;
            font-weight: 700;
        }

        .chat-input {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 8px;
        }

        .activity {
            margin-top: 10px;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            background: var(--surface-2);
            padding: 10px;
            max-height: 150px;
            overflow: auto;
        }

        .activity-item {
            font-size: 0.8rem;
            color: var(--muted);
            margin-bottom: 6px;
        }

        .footer-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            font-size: 0.82rem;
            color: var(--muted);
        }

        .toast {
            position: fixed;
            right: 20px;
            bottom: 20px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-left: 4px solid var(--teal);
            padding: 10px 12px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            display: none;
            z-index: 50;
        }

        @media (max-width: 1120px) {
            .main { grid-template-columns: 1fr; }
            .stats { grid-template-columns: repeat(2, 1fr); }
            .chat { min-height: 480px; }
        }

        @media (max-width: 740px) {
            .toolbar { grid-template-columns: 1fr 1fr; }
            .form-grid { grid-template-columns: 1fr; }
            .stats { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
<div class="shell">
    <header class="topbar">
        <div>
            <h1 class="title">Inventory Command Center</h1>
            <p class="subtitle">Modern product operations with AI assistant, analytics, and quick actions.</p>
        </div>
        <div class="actions">
            <button class="btn-soft" id="themeButton" type="button">Toggle Theme</button>
            <button class="btn-soft" id="seedButton" type="button">Seed Demo Data</button>
            <button class="btn-soft" id="exportButton" type="button">Export CSV</button>
            <button class="btn-danger" id="logoutButton" type="button">Logout</button>
        </div>
    </header>

    <section class="main">
        <article class="panel">
            <section class="stats">
                <div class="stat"><div class="k">Total Products</div><div class="v" id="statTotal">0</div></div>
                <div class="stat"><div class="k">Inventory Value</div><div class="v" id="statValue">$0.00</div></div>
                <div class="stat"><div class="k">Low Stock (<=10)</div><div class="v" id="statLow">0</div></div>
                <div class="stat"><div class="k">Out of Stock</div><div class="v" id="statOut">0</div></div>
            </section>

            <h3 id="formTitle" style="margin:0 0 10px;font-family:Outfit,sans-serif;">Create Product</h3>
            <form id="productForm" class="form-grid">
                <label>Name<input id="name" required maxlength="120"></label>
                <label>SKU<input id="sku" required maxlength="80"></label>
                <label>Price<input id="price" type="number" min="0" step="0.01" required></label>
                <label>Quantity<input id="quantity" type="number" min="0" step="1" required></label>
            </form>
            <div class="actions" style="margin-top:10px;">
                <button class="btn-primary" id="saveButton" type="button">Save Product</button>
                <button class="btn-soft" id="clearButton" type="button">Clear</button>
                <button class="btn-soft" id="restockLowButton" type="button">Restock Low +10</button>
            </div>

            <hr style="border:none;border-top:1px solid var(--border);margin:14px 0;">

            <div class="toolbar">
                <input id="searchInput" type="search" placeholder="Search by name or SKU">
                <select id="sortBy"><option value="id">ID</option><option value="name">Name</option><option value="sku">SKU</option><option value="price">Price</option><option value="quantity">Quantity</option></select>
                <select id="direction"><option value="asc">Asc</option><option value="desc">Desc</option></select>
                <select id="size"><option value="10">10</option><option value="20">20</option><option value="50">50</option></select>
                <button class="btn-soft" id="refreshButton" type="button">Refresh</button>
            </div>

            <div class="list" id="productList"></div>
            <div class="footer-line">
                <div id="pageInfo">Page 1 of 1</div>
                <div class="actions">
                    <button class="btn-soft" id="prevButton" type="button">Prev</button>
                    <button class="btn-soft" id="nextButton" type="button">Next</button>
                </div>
            </div>

            <div class="activity" id="activityLog"></div>
        </article>

        <article class="panel chat">
            <div>
                <h3 style="margin:0;font-family:Outfit,sans-serif;">AI Inventory Copilot</h3>
                <p style="margin:4px 0 0;color:var(--muted);font-size:.85rem;">Ask for stock insights, value, risks, and summary.</p>
            </div>
            <div class="chat-log" id="chatLog"></div>
            <div>
                <div class="chips" id="chipBox"></div>
                <div class="chat-input" style="margin-top:8px;">
                    <input id="chatInput" placeholder="Ask: show low stock, summary, inventory value...">
                    <button class="btn-primary" id="chatSend" type="button">Send</button>
                </div>
            </div>
        </article>
    </section>
</div>

<div class="toast" id="toast"></div>

<script>
    const authKey = "workspaceUser";
    if (!sessionStorage.getItem(authKey)) {
        window.location.replace("/login.html");
    }

    const refs = {
        themeButton: document.getElementById("themeButton"),
        logoutButton: document.getElementById("logoutButton"),
        seedButton: document.getElementById("seedButton"),
        exportButton: document.getElementById("exportButton"),
        restockLowButton: document.getElementById("restockLowButton"),
        saveButton: document.getElementById("saveButton"),
        clearButton: document.getElementById("clearButton"),
        refreshButton: document.getElementById("refreshButton"),
        prevButton: document.getElementById("prevButton"),
        nextButton: document.getElementById("nextButton"),
        name: document.getElementById("name"),
        sku: document.getElementById("sku"),
        price: document.getElementById("price"),
        quantity: document.getElementById("quantity"),
        formTitle: document.getElementById("formTitle"),
        searchInput: document.getElementById("searchInput"),
        sortBy: document.getElementById("sortBy"),
        direction: document.getElementById("direction"),
        size: document.getElementById("size"),
        list: document.getElementById("productList"),
        pageInfo: document.getElementById("pageInfo"),
        statTotal: document.getElementById("statTotal"),
        statValue: document.getElementById("statValue"),
        statLow: document.getElementById("statLow"),
        statOut: document.getElementById("statOut"),
        activityLog: document.getElementById("activityLog"),
        chatLog: document.getElementById("chatLog"),
        chipBox: document.getElementById("chipBox"),
        chatInput: document.getElementById("chatInput"),
        chatSend: document.getElementById("chatSend"),
        toast: document.getElementById("toast")
    };

    const state = {
        editingId: null,
        items: [],
        page: 0,
        totalPages: 1,
        search: "",
        size: 10,
        sortBy: "id",
        direction: "asc",
        searchTimer: null
    };

    function logActivity(message) {
        const stamp = new Date().toLocaleTimeString();
        const row = document.createElement("div");
        row.className = "activity-item";
        row.textContent = `[${stamp}] ${message}`;
        refs.activityLog.prepend(row);
        while (refs.activityLog.childElementCount > 30) {
            refs.activityLog.removeChild(refs.activityLog.lastChild);
        }
    }

    function showToast(message) {
        refs.toast.textContent = message;
        refs.toast.style.display = "block";
        window.setTimeout(() => { refs.toast.style.display = "none"; }, 2200);
    }

    function addChatBubble(text, who) {
        const b = document.createElement("div");
        b.className = `bubble ${who}`;
        b.textContent = text;
        refs.chatLog.appendChild(b);
        refs.chatLog.scrollTop = refs.chatLog.scrollHeight;
    }

    async function requestJson(url, options = {}) {
        const response = await fetch(url, {
            headers: { "Content-Type": "application/json" },
            ...options
        });
        if (!response.ok) {
            let msg = "Request failed";
            try {
                const body = await response.json();
                msg = body.message || msg;
            } catch (_) {}
            throw new Error(msg);
        }
        if (response.status === 204) return null;
        return response.json();
    }

    function safeNum(v) {
        return Number.isFinite(Number(v)) ? Number(v) : 0;
    }

    function currency(v) {
        return new Intl.NumberFormat("en-US", { style: "currency", currency: "USD" }).format(v);
    }

    function updateStats(items, totalElements) {
        const value = items.reduce((sum, p) => sum + safeNum(p.price) * safeNum(p.quantity), 0);
        const low = items.filter((p) => safeNum(p.quantity) <= 10).length;
        const out = items.filter((p) => safeNum(p.quantity) === 0).length;
        refs.statTotal.textContent = String(totalElements);
        refs.statValue.textContent = currency(value);
        refs.statLow.textContent = String(low);
        refs.statOut.textContent = String(out);
    }

    function resetForm() {
        state.editingId = null;
        refs.formTitle.textContent = "Create Product";
        refs.name.value = "";
        refs.sku.value = "";
        refs.price.value = "";
        refs.quantity.value = "";
        refs.name.focus();
    }

    function renderProducts(items) {
        refs.list.innerHTML = "";
        if (!items.length) {
            refs.list.innerHTML = '<div class="row"><div><div class="name">No products found</div><div class="meta">Try adding products or changing filters.</div></div></div>';
            return;
        }

        items.forEach((p) => {
            const row = document.createElement("div");
            row.className = "row";
            const lowTag = safeNum(p.quantity) <= 10 ? '<span class="tag low">Low stock</span>' : '<span class="tag">Healthy</span>';
            row.innerHTML = `
                <div>
                    <div class="name">${p.name}</div>
                    <div class="meta">SKU: ${p.sku} | Price: ${currency(safeNum(p.price))} | Qty: ${p.quantity}</div>
                    ${lowTag}
                </div>
                <div class="row-actions">
                    <button class="btn-soft" data-a="edit">Edit</button>
                    <button class="btn-soft" data-a="in">+5</button>
                    <button class="btn-soft" data-a="out">-5</button>
                    <button class="btn-danger" data-a="del">Delete</button>
                </div>`;

            row.addEventListener("click", async (e) => {
                const btn = e.target.closest("button");
                if (!btn) return;
                const action = btn.getAttribute("data-a");
                if (action === "edit") return startEdit(p.id);
                if (action === "in") return adjustInventory(p.id, 5);
                if (action === "out") return adjustInventory(p.id, -5);
                if (action === "del") return deleteProduct(p.id);
            });
            refs.list.appendChild(row);
        });
    }

    function startEdit(id) {
        const p = state.items.find((x) => x.id === id);
        if (!p) return;
        state.editingId = id;
        refs.formTitle.textContent = "Update Product";
        refs.name.value = p.name;
        refs.sku.value = p.sku;
        refs.price.value = p.price;
        refs.quantity.value = p.quantity;
        logActivity(`Editing product ${p.sku}`);
    }

    async function deleteProduct(id) {
        if (!confirm("Delete this product?")) return;
        try {
            await requestJson(`/products/${id}`, { method: "DELETE" });
            logActivity(`Deleted product #${id}`);
            showToast("Product deleted");
            if (state.editingId === id) resetForm();
            await loadProducts();
        } catch (e) {
            showToast(e.message);
        }
    }

    async function adjustInventory(id, delta) {
        try {
            await requestJson(`/products/${id}/inventory`, {
                method: "PATCH",
                body: JSON.stringify({ delta })
            });
            logActivity(`Adjusted inventory for #${id} by ${delta}`);
            await loadProducts();
        } catch (e) {
            showToast(e.message);
        }
    }

    async function loadProducts() {
        const params = new URLSearchParams({
            page: String(state.page),
            size: String(state.size),
            sortBy: state.sortBy,
            direction: state.direction
        });
        if (state.search) params.set("search", state.search);

        try {
            const data = await requestJson(`/products?${params.toString()}`);
            state.items = data.items || [];
            state.totalPages = Math.max(data.totalPages || 1, 1);
            renderProducts(state.items);
            updateStats(state.items, data.totalElements || 0);
            refs.pageInfo.textContent = `Page ${(data.page || 0) + 1} of ${state.totalPages} | total ${data.totalElements || 0}`;
            refs.prevButton.disabled = !data.hasPrevious;
            refs.nextButton.disabled = !data.hasNext;
        } catch (e) {
            showToast(e.message);
        }
    }

    async function saveProduct() {
        const payload = {
            name: refs.name.value.trim(),
            sku: refs.sku.value.trim(),
            price: safeNum(refs.price.value),
            quantity: Math.floor(safeNum(refs.quantity.value))
        };

        if (!payload.name || !payload.sku) return showToast("Name and SKU are required");

        const isEdit = state.editingId !== null;
        const url = isEdit ? `/products/${state.editingId}` : "/products";
        const method = isEdit ? "PUT" : "POST";

        try {
            await requestJson(url, { method, body: JSON.stringify(payload) });
            logActivity(`${isEdit ? "Updated" : "Created"} ${payload.sku}`);
            showToast(isEdit ? "Product updated" : "Product created");
            resetForm();
            await loadProducts();
        } catch (e) {
            showToast(e.message);
        }
    }

    async function restockLow() {
        const low = state.items.filter((p) => safeNum(p.quantity) <= 10);
        if (!low.length) return showToast("No low-stock products on current page");
        for (const p of low) {
            await adjustInventory(p.id, 10);
        }
        logActivity(`Bulk restocked ${low.length} products`);
        showToast("Low-stock products restocked");
    }

    async function seedDemoData() {
        const seed = [
            { name: "Noise Cancelling Headphones", sku: "HEAD-401", price: 199.99, quantity: 8 },
            { name: "Ergonomic Keyboard", sku: "KEY-202", price: 109.5, quantity: 24 },
            { name: "4K Docking Station", sku: "DOCK-900", price: 289.0, quantity: 3 }
        ];

        let created = 0;
        for (const item of seed) {
            try {
                await requestJson("/products", { method: "POST", body: JSON.stringify(item) });
                created += 1;
            } catch (_) {}
        }
        logActivity(`Seeded demo data (${created} created)`);
        showToast(`Seeded ${created} products`);
        await loadProducts();
    }

    function exportCsv() {
        const headers = ["id", "name", "sku", "price", "quantity"];
        const lines = [headers.join(",")];
        state.items.forEach((p) => lines.push([p.id, p.name, p.sku, p.price, p.quantity].map((x) => `"${String(x).replaceAll('"', '""')}"`).join(",")));
        const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "products-page.csv";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        logActivity("Exported current page to CSV");
    }

    async function sendChat(message) {
        const msg = String(message || refs.chatInput.value || "").trim();
        if (!msg) return;
        refs.chatInput.value = "";
        addChatBubble(msg, "user");

        try {
            const data = await requestJson("/assistant/chat", {
                method: "POST",
                body: JSON.stringify({ message: msg })
            });
            addChatBubble(data.reply || "No response", "bot");
            renderChips(data.suggestions || []);
            logActivity(`AI query: ${msg}`);
        } catch (e) {
            addChatBubble(e.message, "bot");
        }
    }

    function renderChips(chips) {
        refs.chipBox.innerHTML = "";
        chips.forEach((c) => {
            const btn = document.createElement("button");
            btn.className = "chip";
            btn.type = "button";
            btn.textContent = c;
            btn.addEventListener("click", () => sendChat(c));
            refs.chipBox.appendChild(btn);
        });
    }

    refs.saveButton.addEventListener("click", saveProduct);
    refs.clearButton.addEventListener("click", resetForm);
    refs.refreshButton.addEventListener("click", loadProducts);
    refs.seedButton.addEventListener("click", seedDemoData);
    refs.exportButton.addEventListener("click", exportCsv);
    refs.restockLowButton.addEventListener("click", restockLow);

    refs.searchInput.addEventListener("input", () => {
        state.search = refs.searchInput.value.trim();
        state.page = 0;
        if (state.searchTimer) clearTimeout(state.searchTimer);
        state.searchTimer = setTimeout(loadProducts, 200);
    });

    refs.sortBy.addEventListener("change", () => { state.sortBy = refs.sortBy.value; state.page = 0; loadProducts(); });
    refs.direction.addEventListener("change", () => { state.direction = refs.direction.value; state.page = 0; loadProducts(); });
    refs.size.addEventListener("change", () => { state.size = Number(refs.size.value); state.page = 0; loadProducts(); });
    refs.prevButton.addEventListener("click", () => { if (state.page > 0) { state.page -= 1; loadProducts(); } });
    refs.nextButton.addEventListener("click", () => { if (state.page + 1 < state.totalPages) { state.page += 1; loadProducts(); } });

    refs.themeButton.addEventListener("click", () => {
        document.body.classList.toggle("theme-dark");
        showToast(document.body.classList.contains("theme-dark") ? "Dark theme enabled" : "Light theme enabled");
    });

    refs.logoutButton.addEventListener("click", () => {
        sessionStorage.removeItem(authKey);
        window.location.replace("/login.html");
    });

    refs.chatSend.addEventListener("click", () => sendChat());
    refs.chatInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
            e.preventDefault();
            sendChat();
        }
    });

    document.addEventListener("keydown", (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "k") {
            e.preventDefault();
            refs.chatInput.focus();
        }
    });

    addChatBubble("Hi, I am your AI Inventory Copilot. Ask for summary, low stock, or inventory value.", "bot");
    renderChips(["Give me a summary", "Show low stock items", "What is my inventory value?"]);
    loadProducts();
</script>
</body>
</html>
