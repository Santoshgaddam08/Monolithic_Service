<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SLA Queue Monitor</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600;700;800&family=IBM+Plex+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f1f5ff;
            --surface: #ffffff;
            --surface-2: #f6f8fe;
            --ink: #1f2a44;
            --muted: #5b6884;
            --line: #d8e0f2;
            --accent: #ff5f3d;
            --accent-2: #ffa45f;
            --danger: #d72638;
            --warn: #f4a300;
            --ok: #14a44d;
            --shadow: 0 16px 40px rgba(18, 35, 76, 0.11);
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            min-height: 100vh;
            font-family: "IBM Plex Sans", sans-serif;
            color: var(--ink);
            background:
                radial-gradient(850px 420px at -20% -20%, #d9e4ff 0, transparent 68%),
                radial-gradient(880px 420px at 120% -30%, #ffe2d9 0, transparent 70%),
                var(--bg);
        }

        .shell {
            width: min(1360px, 96vw);
            margin: 24px auto;
            display: grid;
            gap: 16px;
        }

        .top {
            border: 1px solid var(--line);
            background: var(--surface);
            border-radius: 20px;
            padding: 16px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        h1 {
            margin: 0;
            font-family: "Sora", sans-serif;
            font-size: clamp(1.4rem, 2.8vw, 2rem);
            letter-spacing: -0.03em;
        }

        .sub {
            margin-top: 4px;
            color: var(--muted);
            font-size: .9rem;
        }

        .actions { display: flex; gap: 8px; flex-wrap: wrap; }
        button, select, input, textarea { font: inherit; }

        button {
            border: none;
            border-radius: 10px;
            padding: 9px 11px;
            font-weight: 700;
            cursor: pointer;
        }

        .btn-primary { color: #fff; background: linear-gradient(130deg, var(--accent), var(--accent-2)); }
        .btn-soft { color: var(--ink); background: var(--surface-2); border: 1px solid var(--line); }
        .btn-danger { color: var(--danger); background: rgba(215, 38, 56, 0.12); border: 1px solid rgba(215, 38, 56, 0.25); }

        .layout {
            display: grid;
            grid-template-columns: 1.4fr 1fr;
            gap: 16px;
        }

        .panel {
            border: 1px solid var(--line);
            background: var(--surface);
            border-radius: 20px;
            box-shadow: var(--shadow);
            padding: 14px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }

        .stat {
            border: 1px solid var(--line);
            border-radius: 12px;
            padding: 10px;
            background: var(--surface-2);
        }

        .k { font-size: .76rem; color: var(--muted); }
        .v { font-family: "Sora", sans-serif; font-weight: 800; margin-top: 3px; }

        .controls {
            display: grid;
            grid-template-columns: 1.2fr repeat(5, .6fr) auto;
            gap: 8px;
            margin-bottom: 10px;
        }

        input, select, textarea {
            width: 100%;
            border: 1px solid var(--line);
            border-radius: 10px;
            background: var(--surface-2);
            padding: 9px;
            color: var(--ink);
        }

        .tickets {
            display: grid;
            gap: 8px;
            max-height: 420px;
            overflow: auto;
        }

        .ticket {
            border: 1px solid var(--line);
            border-radius: 12px;
            background: var(--surface-2);
            padding: 10px;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 8px;
        }

        .tt { font-weight: 800; font-family: "Sora", sans-serif; }
        .meta { color: var(--muted); font-size: .82rem; margin-top: 4px; }
        .tags { margin-top: 6px; display: flex; gap: 6px; flex-wrap: wrap; }

        .tag {
            border: 1px solid var(--line);
            border-radius: 999px;
            padding: 3px 8px;
            font-size: .72rem;
            font-weight: 700;
            background: #fff;
        }

        .tag.warn { color: #8f5f00; background: rgba(244,163,0,.13); border-color: rgba(244,163,0,.35); }
        .tag.danger { color: var(--danger); background: rgba(215,38,56,.13); border-color: rgba(215,38,56,.35); }
        .tag.ok { color: var(--ok); background: rgba(20,164,77,.13); border-color: rgba(20,164,77,.35); }

        .row-actions { display: flex; gap: 6px; flex-wrap: wrap; align-content: center; }

        .pager {
            margin-top: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--muted);
            font-size: .84rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        textarea { min-height: 70px; resize: vertical; }

        .chat {
            display: grid;
            grid-template-rows: auto 1fr auto;
            gap: 8px;
            min-height: 610px;
        }

        .chatlog {
            border: 1px solid var(--line);
            border-radius: 12px;
            background: var(--surface-2);
            padding: 10px;
            max-height: 450px;
            overflow: auto;
            display: grid;
            gap: 8px;
        }

        .bubble {
            max-width: 88%;
            border-radius: 12px;
            padding: 9px 10px;
            font-size: .86rem;
            line-height: 1.45;
        }

        .user { margin-left: auto; color: #fff; background: linear-gradient(130deg, var(--accent), var(--accent-2)); }
        .bot { border: 1px solid var(--line); background: #fff; }

        .chips { display: flex; gap: 6px; flex-wrap: wrap; }
        .chip { border: 1px solid var(--line); background: var(--surface-2); border-radius: 999px; padding: 6px 9px; font-size: .75rem; cursor: pointer; }

        .activity {
            margin-top: 10px;
            border: 1px solid var(--line);
            border-radius: 12px;
            background: var(--surface-2);
            padding: 10px;
            max-height: 120px;
            overflow: auto;
            color: var(--muted);
            font-size: .82rem;
        }

        @media (max-width: 1180px) {
            .layout { grid-template-columns: 1fr; }
            .stats { grid-template-columns: repeat(3, 1fr); }
        }

        @media (max-width: 760px) {
            .controls { grid-template-columns: 1fr 1fr; }
            .form-grid { grid-template-columns: 1fr; }
            .stats { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
<div class="shell">
    <header class="top">
        <div>
            <h1>Real-Time SLA Queue Monitor</h1>
            <div class="sub">Track active incidents, SLA timers, escalations, and team workload.</div>
        </div>
        <div class="actions">
            <button id="seed" class="btn-soft" type="button">Seed Incidents</button>
            <button id="refresh" class="btn-soft" type="button">Refresh</button>
            <button id="logout" class="btn-danger" type="button">Logout</button>
        </div>
    </header>

    <section class="layout">
        <article class="panel">
            <section class="stats">
                <div class="stat"><div class="k">Total</div><div class="v" id="sTotal">0</div></div>
                <div class="stat"><div class="k">Open</div><div class="v" id="sOpen">0</div></div>
                <div class="stat"><div class="k">In Progress</div><div class="v" id="sProg">0</div></div>
                <div class="stat"><div class="k">Blocked</div><div class="v" id="sBlock">0</div></div>
                <div class="stat"><div class="k">Breached</div><div class="v" id="sBreach">0</div></div>
                <div class="stat"><div class="k">Due Soon</div><div class="v" id="sSoon">0</div></div>
            </section>

            <div class="controls">
                <input id="search" placeholder="Search title/customer/email">
                <select id="statusFilter"><option value="">All Status</option><option>OPEN</option><option>IN_PROGRESS</option><option>BLOCKED</option><option>RESOLVED</option></select>
                <select id="priorityFilter"><option value="">All Priority</option><option>LOW</option><option>MEDIUM</option><option>HIGH</option><option>CRITICAL</option></select>
                <select id="sortBy"><option value="id">ID</option><option value="slaDueAt">SLA</option><option value="priority">Priority</option><option value="createdAt">Created</option><option value="status">Status</option></select>
                <select id="direction"><option value="asc">Asc</option><option value="desc">Desc</option></select>
                <select id="size"><option>10</option><option>20</option><option>50</option></select>
                <button id="escalate" class="btn-primary" type="button">Escalate Breached</button>
            </div>

            <div class="tickets" id="tickets"></div>
            <div class="pager">
                <div id="pageInfo">Page 1 of 1</div>
                <div class="actions">
                    <button id="prev" class="btn-soft" type="button">Prev</button>
                    <button id="next" class="btn-soft" type="button">Next</button>
                </div>
            </div>

            <hr style="border:none;border-top:1px solid var(--line);margin:12px 0;">
            <h3 style="margin:0 0 8px;font-family:Sora,sans-serif;" id="formTitle">Create Incident Ticket</h3>
            <div class="form-grid">
                <input id="title" placeholder="Issue title">
                <select id="priority"><option>LOW</option><option selected>MEDIUM</option><option>HIGH</option><option>CRITICAL</option></select>
                <input id="customerName" placeholder="Customer name">
                <input id="customerEmail" placeholder="Customer email">
                <input id="assignedTo" placeholder="Assignee (optional)">
                <input id="slaMinutes" type="number" min="5" value="60" placeholder="SLA minutes">
            </div>
            <div style="margin-top:8px;"><textarea id="description" placeholder="Issue description"></textarea></div>
            <div class="actions" style="margin-top:8px;">
                <button id="save" class="btn-primary" type="button">Save Ticket</button>
                <button id="clear" class="btn-soft" type="button">Clear</button>
            </div>
            <div class="activity" id="activity"></div>
        </article>

        <article class="panel chat">
            <div>
                <h3 style="margin:0;font-family:Sora,sans-serif;">AI Triage Assistant</h3>
                <div class="sub">Use AI for SLA breach checks, workload distribution, and next action.</div>
            </div>
            <div class="chatlog" id="chatlog"></div>
            <div>
                <div class="chips" id="chips"></div>
                <div style="display:grid;grid-template-columns:1fr auto;gap:8px;margin-top:8px;">
                    <input id="chatInput" placeholder="Ask: Show SLA breaches / Who is overloaded?">
                    <button id="chatSend" class="btn-primary" type="button">Send</button>
                </div>
            </div>
        </article>
    </section>
</div>

<script>
    if (!sessionStorage.getItem("workspaceUser")) {
        window.location.replace("/login.html");
    }

    const els = {
        seed: document.getElementById("seed"), refresh: document.getElementById("refresh"), logout: document.getElementById("logout"),
        search: document.getElementById("search"), statusFilter: document.getElementById("statusFilter"), priorityFilter: document.getElementById("priorityFilter"),
        sortBy: document.getElementById("sortBy"), direction: document.getElementById("direction"), size: document.getElementById("size"), escalate: document.getElementById("escalate"),
        tickets: document.getElementById("tickets"), pageInfo: document.getElementById("pageInfo"), prev: document.getElementById("prev"), next: document.getElementById("next"),
        sTotal: document.getElementById("sTotal"), sOpen: document.getElementById("sOpen"), sProg: document.getElementById("sProg"), sBlock: document.getElementById("sBlock"), sBreach: document.getElementById("sBreach"), sSoon: document.getElementById("sSoon"),
        formTitle: document.getElementById("formTitle"),
        title: document.getElementById("title"), description: document.getElementById("description"), priority: document.getElementById("priority"), customerName: document.getElementById("customerName"), customerEmail: document.getElementById("customerEmail"), assignedTo: document.getElementById("assignedTo"), slaMinutes: document.getElementById("slaMinutes"),
        save: document.getElementById("save"), clear: document.getElementById("clear"), activity: document.getElementById("activity"),
        chatlog: document.getElementById("chatlog"), chips: document.getElementById("chips"), chatInput: document.getElementById("chatInput"), chatSend: document.getElementById("chatSend")
    };

    const state = { page: 0, totalPages: 1, items: [], editingId: null, timer: null };

    async function api(url, options = {}) {
        const res = await fetch(url, { headers: { "Content-Type": "application/json" }, ...options });
        if (!res.ok) {
            let msg = "Request failed";
            try { msg = (await res.json()).message || msg; } catch (_) {}
            throw new Error(msg);
        }
        if (res.status === 204) return null;
        return res.json();
    }

    function log(msg) {
        const row = document.createElement("div");
        row.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        els.activity.prepend(row);
        while (els.activity.childElementCount > 20) els.activity.removeChild(els.activity.lastChild);
    }

    function fmt(sec) {
        const abs = Math.abs(sec);
        const m = Math.floor(abs / 60);
        const s = abs % 60;
        return `${sec < 0 ? "-" : ""}${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
    }

    function slaTag(t) {
        if (t.status === "RESOLVED") return '<span class="tag ok">Resolved</span>';
        if (t.breached) return `<span class="tag danger">Breached ${fmt(t.slaSecondsRemaining)}</span>`;
        if (t.slaSecondsRemaining <= 1800) return `<span class="tag warn">Due ${fmt(t.slaSecondsRemaining)}</span>`;
        return `<span class="tag ok">SLA ${fmt(t.slaSecondsRemaining)}</span>`;
    }

    function renderTickets(items) {
        els.tickets.innerHTML = "";
        if (!items.length) {
            els.tickets.innerHTML = '<div class="ticket"><div><div class="tt">No tickets found</div><div class="meta">Create an issue to start queue monitoring.</div></div></div>';
            return;
        }

        items.forEach((t) => {
            const row = document.createElement("div");
            row.className = "ticket";
            row.innerHTML = `
                <div>
                    <div class="tt">#${t.id} ${t.title}</div>
                    <div class="meta">${t.customerName} (${t.customerEmail}) | Priority: ${t.priority} | Status: ${t.status} | Owner: ${t.assignedTo || "Unassigned"}</div>
                    <div class="tags">${slaTag(t)}</div>
                </div>
                <div class="row-actions">
                    <button class="btn-soft" data-a="edit">Edit</button>
                    <button class="btn-soft" data-a="prog">Start</button>
                    <button class="btn-soft" data-a="block">Block</button>
                    <button class="btn-soft" data-a="done">Resolve</button>
                    <button class="btn-soft" data-a="assign">Assign</button>
                    <button class="btn-danger" data-a="del">Delete</button>
                </div>`;

            row.addEventListener("click", async (e) => {
                const btn = e.target.closest("button");
                if (!btn) return;
                const action = btn.getAttribute("data-a");
                if (action === "edit") return fillForm(t);
                if (action === "prog") return updateStatus(t.id, "IN_PROGRESS");
                if (action === "block") return updateStatus(t.id, "BLOCKED");
                if (action === "done") return updateStatus(t.id, "RESOLVED");
                if (action === "assign") return assignTicket(t.id);
                if (action === "del") return deleteTicket(t.id);
            });

            els.tickets.appendChild(row);
        });
    }

    async function loadSummary() {
        const s = await api("/tickets/summary");
        els.sTotal.textContent = s.total;
        els.sOpen.textContent = s.open;
        els.sProg.textContent = s.inProgress;
        els.sBlock.textContent = s.blocked;
        els.sBreach.textContent = s.breached;
        els.sSoon.textContent = s.dueSoon;
    }

    async function loadTickets() {
        const p = new URLSearchParams({
            page: String(state.page),
            size: String(els.size.value),
            sortBy: els.sortBy.value,
            direction: els.direction.value
        });
        if (els.search.value.trim()) p.set("search", els.search.value.trim());
        if (els.statusFilter.value) p.set("status", els.statusFilter.value);
        if (els.priorityFilter.value) p.set("priority", els.priorityFilter.value);

        const data = await api(`/tickets?${p.toString()}`);
        state.items = data.items || [];
        state.totalPages = Math.max(data.totalPages || 1, 1);
        renderTickets(state.items);
        els.pageInfo.textContent = `Page ${(data.page || 0) + 1} of ${state.totalPages} | total ${data.totalElements || 0}`;
        els.prev.disabled = !data.hasPrevious;
        els.next.disabled = !data.hasNext;
        await loadSummary();
    }

    function fillForm(t) {
        state.editingId = t.id;
        els.formTitle.textContent = `Edit Ticket #${t.id}`;
        els.title.value = t.title;
        els.description.value = t.description;
        els.priority.value = t.priority;
        els.customerName.value = t.customerName;
        els.customerEmail.value = t.customerEmail;
        els.assignedTo.value = t.assignedTo || "";
        els.slaMinutes.value = 60;
    }

    function clearForm() {
        state.editingId = null;
        els.formTitle.textContent = "Create Incident Ticket";
        els.title.value = "";
        els.description.value = "";
        els.priority.value = "MEDIUM";
        els.customerName.value = "";
        els.customerEmail.value = "";
        els.assignedTo.value = "";
        els.slaMinutes.value = 60;
    }

    async function saveTicket() {
        const payload = {
            title: els.title.value.trim(),
            description: els.description.value.trim(),
            customerName: els.customerName.value.trim(),
            customerEmail: els.customerEmail.value.trim(),
            priority: els.priority.value,
            assignedTo: els.assignedTo.value.trim(),
            slaMinutes: Number(els.slaMinutes.value)
        };

        const url = state.editingId === null ? "/tickets" : `/tickets/${state.editingId}`;
        const method = state.editingId === null ? "POST" : "PUT";

        try {
            await api(url, { method, body: JSON.stringify(payload) });
            log(`${state.editingId === null ? "Created" : "Updated"} ticket ${payload.title}`);
            clearForm();
            await loadTickets();
        } catch (e) {
            alert(e.message);
        }
    }

    async function updateStatus(id, status) {
        await api(`/tickets/${id}/status`, { method: "PATCH", body: JSON.stringify({ status }) });
        log(`Ticket #${id} -> ${status}`);
        await loadTickets();
    }

    async function assignTicket(id) {
        const assignedTo = prompt("Assign ticket to:");
        if (!assignedTo) return;
        await api(`/tickets/${id}/assign`, { method: "PATCH", body: JSON.stringify({ assignedTo }) });
        log(`Ticket #${id} assigned to ${assignedTo}`);
        await loadTickets();
    }

    async function deleteTicket(id) {
        if (!confirm("Delete this ticket?")) return;
        await api(`/tickets/${id}`, { method: "DELETE" });
        log(`Deleted ticket #${id}`);
        if (state.editingId === id) clearForm();
        await loadTickets();
    }

    async function seed() {
        const seedData = [
            { title: "Checkout fails for VISA cards", description: "Customers report payment timeout for VISA.", customerName: "Ava Miles", customerEmail: "ava@example.com", priority: "CRITICAL", assignedTo: "Rohit", slaMinutes: 15 },
            { title: "Password reset email delayed", description: "Email arrives after 20 minutes.", customerName: "Liam Fox", customerEmail: "liam@example.com", priority: "HIGH", assignedTo: "Priya", slaMinutes: 45 },
            { title: "Mobile app crash on profile", description: "Android app crashes when opening profile.", customerName: "Nina Wells", customerEmail: "nina@example.com", priority: "MEDIUM", assignedTo: "", slaMinutes: 90 }
        ];

        let created = 0;
        for (const t of seedData) {
            try { await api("/tickets", { method: "POST", body: JSON.stringify(t) }); created += 1; } catch (_) {}
        }
        log(`Seeded ${created} incidents`);
        await loadTickets();
    }

    async function escalateBreached() {
        const breached = state.items.filter((t) => t.breached);
        if (!breached.length) {
            alert("No breached tickets on current page.");
            return;
        }
        for (const t of breached) {
            await updateStatus(t.id, "BLOCKED");
            if (!t.assignedTo) {
                await api(`/tickets/${t.id}/assign`, { method: "PATCH", body: JSON.stringify({ assignedTo: "Escalation Desk" }) });
            }
        }
        log(`Escalated ${breached.length} breached tickets`);
        await loadTickets();
    }

    function tickCountdown() {
        state.items = state.items.map((t) => ({ ...t, slaSecondsRemaining: t.slaSecondsRemaining - (t.status === "RESOLVED" ? 0 : 1), breached: t.status !== "RESOLVED" && (t.slaSecondsRemaining - 1) < 0 }));
        renderTickets(state.items);
    }

    function addBubble(text, who) {
        const el = document.createElement("div");
        el.className = `bubble ${who}`;
        el.textContent = text;
        els.chatlog.appendChild(el);
        els.chatlog.scrollTop = els.chatlog.scrollHeight;
    }

    function renderChips(items) {
        els.chips.innerHTML = "";
        items.forEach((c) => {
            const b = document.createElement("button");
            b.className = "chip";
            b.type = "button";
            b.textContent = c;
            b.addEventListener("click", () => sendChat(c));
            els.chips.appendChild(b);
        });
    }

    async function sendChat(message) {
        const prompt = (message || els.chatInput.value || "").trim();
        if (!prompt) return;
        els.chatInput.value = "";
        addBubble(prompt, "user");
        try {
            const data = await api("/assistant/chat", { method: "POST", body: JSON.stringify({ message: prompt }) });
            addBubble(data.reply || "No response", "bot");
            renderChips(data.suggestions || []);
        } catch (e) {
            addBubble(e.message, "bot");
        }
    }

    els.save.addEventListener("click", saveTicket);
    els.clear.addEventListener("click", clearForm);
    els.seed.addEventListener("click", seed);
    els.refresh.addEventListener("click", loadTickets);
    els.escalate.addEventListener("click", escalateBreached);

    [els.statusFilter, els.priorityFilter, els.sortBy, els.direction, els.size].forEach((el) => {
        el.addEventListener("change", () => { state.page = 0; loadTickets(); });
    });

    els.search.addEventListener("input", () => {
        if (state.timer) clearTimeout(state.timer);
        state.timer = setTimeout(() => { state.page = 0; loadTickets(); }, 200);
    });

    els.prev.addEventListener("click", () => { if (state.page > 0) { state.page -= 1; loadTickets(); } });
    els.next.addEventListener("click", () => { if (state.page + 1 < state.totalPages) { state.page += 1; loadTickets(); } });

    els.logout.addEventListener("click", () => {
        sessionStorage.removeItem("workspaceUser");
        window.location.replace("/login.html");
    });

    els.chatSend.addEventListener("click", () => sendChat());
    els.chatInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
            e.preventDefault();
            sendChat();
        }
    });

    setInterval(tickCountdown, 1000);
    setInterval(loadSummary, 15000);

    addBubble("I can help triage incidents. Ask for summary, SLA breaches, workload, or next action.", "bot");
    renderChips(["Give me queue summary", "Show SLA breaches", "Who has most workload?", "What should I handle next?"]);
    clearForm();
    loadTickets();
</script>
</body>
</html>
